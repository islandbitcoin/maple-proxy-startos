<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maple Proxy</title>
<style>
  :root { --bg:#0f0f0f; --card:#1a1a1a; --border:#2a2a2a; --text:#e5e5e5; --muted:#888; --accent:#22c55e; --accent2:#16a34a; --user-bg:#1e3a2a; --ai-bg:#1a1a1a; }
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; }
  header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:var(--card); }
  header h1 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px; }
  header h1 span { color:var(--accent); }
  .settings { display:flex; gap:12px; align-items:center; }
  .settings select, .settings input { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:8px; font-size:13px; }
  .settings select { min-width:160px; }
  .settings input { width:200px; }
  #chat { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
  .msg { max-width:80%; padding:12px 16px; border-radius:16px; font-size:14px; line-height:1.6; white-space:pre-wrap; word-wrap:break-word; }
  .msg.user { align-self:flex-end; background:var(--user-bg); border:1px solid #2d5a3d; border-bottom-right-radius:4px; }
  .msg.assistant { align-self:flex-start; background:var(--ai-bg); border:1px solid var(--border); border-bottom-left-radius:4px; }
  .msg.system { align-self:center; color:var(--muted); font-size:12px; background:transparent; }
  .msg code { background:#111; padding:2px 5px; border-radius:4px; font-size:13px; }
  .msg pre { background:#111; padding:12px; border-radius:8px; overflow-x:auto; margin:8px 0; }
  .msg pre code { background:transparent; padding:0; }
  .typing { align-self:flex-start; color:var(--muted); font-size:13px; padding:8px 16px; }
  .typing::after { content:'...'; animation:dots 1.5s infinite; }
  @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }
  #input-area { padding:16px 20px; border-top:1px solid var(--border); background:var(--card); display:flex; gap:10px; }
  #input-area textarea { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:10px 14px; border-radius:12px; font-size:14px; font-family:inherit; resize:none; min-height:44px; max-height:200px; line-height:1.5; }
  #input-area textarea:focus { outline:none; border-color:var(--accent); }
  #input-area button { background:var(--accent); color:#000; border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer; font-size:14px; transition:background .15s; }
  #input-area button:hover { background:var(--accent2); }
  #input-area button:disabled { opacity:0.5; cursor:not-allowed; }
  .empty { display:flex; align-items:center; justify-content:center; flex:1; color:var(--muted); font-size:15px; text-align:center; padding:40px; }
  .empty h2 { font-size:24px; color:var(--text); margin-bottom:8px; }
</style>
</head>
<body>
  <header>
    <h1>üçÅ <span>Maple</span> Proxy</h1>
    <div class="settings">
      <select id="model"></select>
      <input id="apiKey" type="password" placeholder="API key (if required)"/>
    </div>
  </header>
  <div id="chat">
    <div class="empty">
      <div>
        <h2>üçÅ Maple Proxy</h2>
        <p>OpenAI-compatible AI chat running on your StartOS server.</p>
        <p style="margin-top:8px;font-size:13px">Select a model above and start chatting.</p>
      </div>
    </div>
  </div>
  <div id="input-area">
    <textarea id="prompt" rows="1" placeholder="Send a message..." autofocus></textarea>
    <button id="send">Send</button>
  </div>

<script>
const chat = document.getElementById('chat');
const prompt = document.getElementById('prompt');
const sendBtn = document.getElementById('send');
const modelSel = document.getElementById('model');
const apiKeyInput = document.getElementById('apiKey');
let messages = [];
let streaming = false;

// Auto-resize textarea
prompt.addEventListener('input', () => {
  prompt.style.height = 'auto';
  prompt.style.height = Math.min(prompt.scrollHeight, 200) + 'px';
});

// Load models
async function loadModels() {
  try {
    const headers = {};
    const key = apiKeyInput.value.trim();
    if (key) headers['Authorization'] = 'Bearer ' + key;
    const res = await fetch('/v1/models', { headers });
    const data = await res.json();
    modelSel.innerHTML = '';
    (data.data || []).forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.id;
      modelSel.appendChild(opt);
    });
    if (!modelSel.options.length) {
      const opt = document.createElement('option');
      opt.value = 'maple';
      opt.textContent = 'maple (default)';
      modelSel.appendChild(opt);
    }
  } catch (e) {
    console.error('Failed to load models:', e);
    const opt = document.createElement('option');
    opt.value = 'maple';
    opt.textContent = 'maple (default)';
    modelSel.appendChild(opt);
  }
}

function addMsg(role, content) {
  const empty = chat.querySelector('.empty');
  if (empty) empty.remove();
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.textContent = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

async function send() {
  const text = prompt.value.trim();
  if (!text || streaming) return;
  prompt.value = '';
  prompt.style.height = 'auto';
  addMsg('user', text);
  messages.push({ role: 'user', content: text });

  streaming = true;
  sendBtn.disabled = true;

  const headers = { 'Content-Type': 'application/json' };
  const key = apiKeyInput.value.trim();
  if (key) headers['Authorization'] = 'Bearer ' + key;

  const typing = document.createElement('div');
  typing.className = 'typing';
  typing.textContent = 'Thinking';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  try {
    const res = await fetch('/v1/chat/completions', {
      method: 'POST',
      headers,
      body: JSON.stringify({
        model: modelSel.value,
        messages: messages,
        stream: true,
      }),
    });

    typing.remove();

    if (!res.ok) {
      const err = await res.text();
      addMsg('system', '‚ö†Ô∏è Error: ' + (err || res.statusText));
      streaming = false;
      sendBtn.disabled = false;
      return;
    }

    const msgDiv = addMsg('assistant', '');
    let fullContent = '';

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (data === '[DONE]') continue;
        try {
          const json = JSON.parse(data);
          const delta = json.choices?.[0]?.delta?.content;
          if (delta) {
            fullContent += delta;
            msgDiv.textContent = fullContent;
            chat.scrollTop = chat.scrollHeight;
          }
        } catch {}
      }
    }

    messages.push({ role: 'assistant', content: fullContent });
  } catch (e) {
    typing.remove();
    addMsg('system', '‚ö†Ô∏è ' + e.message);
  }

  streaming = false;
  sendBtn.disabled = false;
  prompt.focus();
}

sendBtn.addEventListener('click', send);
prompt.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
apiKeyInput.addEventListener('change', loadModels);

loadModels();
</script>
</body>
</html>
